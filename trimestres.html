<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis calificaciones</title>
    <link rel="stylesheet" href="/src/css/estilos.css">
    <!-- Theme color -->
    <meta name="theme-color" content="#1d695f">
    <!-- Theme color on ios -->
    <meta name="apple-mobile-web-app-status-bar-style" content="#1d695f">
    <!-- Theme color on ms phones -->
    <meta name="msapplication-navbutton-color" content="#1d695f">
</head>
<body>
    <nav id="menu">
        <ul class="responsive">
            <li>
                <a href="index.html">Inicio</a>
            </li>

            <li>
                <a href="calificaciones.html">Calificaciones</a>
            </li>

            <li id="mostrar_trimestres">
                <a href="trimestres.html">Trimestres</a>
            </li>
        </ul>

        <ul class="perfil">
            <!-- Show the avatar of current user -->
            <li>
                <img id="imagen_usuario" referrerpolicy="no-referrer" alt="Avatar" id="avatar"
                    class="w-8 h-8 rounded-full">
            <li class="texto_nombre_usuario">
                <a href="#" id="nombre"></a>
            </li>

            <li>
                <a href="#" id="cerrar"></a>
            </li>
        </ul>
    </nav>
    
    <header>
        <!-- Insertar el logo de la universidad -->
        <img src="/src/images/logo.png" 
            alt="Logo de la universidad">
        <p>Administraci√≥n de mis calificaciones</p>      
    </header>
  
    <main id="main">
        <section class="section-izquierda">
            <p>Datos del trimestre</p>
            <form action="" id="formulario">
                <label for="nombre">
                    Trimestre
                    <input name="nombre" type="text" required>
                </label>

                <label for="fecha_inicio">
                    Fecha de inicio
                    <input name="fecha_inicio" type="date" required>
                </label>

                <label for="fecha_fin">
                    Fecha de fin
                    <input name="fecha_fin" type="date" required>
                </label>

                <div class="footer">
                    <button id="guardar" type="button">
                        Guardar
                    </button>
                </div>
                
            </form>
        </section>

        <section class="section-derecha">
            <p>Trimestres registrados</p>
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Nombre</th>
                        <th>Fechas</th>
                        <th>Tareas</th>
                    </tr>
                </thead>

                <tbody id="trimestres">
                               
                </tbody>
            </table>
        </section>
    </main>
    <!-- Incluir el modelo trimestres para manipular la coleccion -->
    <script type="module" >
        import './src/js/auth';
        
        import {getUser, getAdmin} from './src/js/user';
        
        import {guardarTrimestre, obtenerTrimestres, obtenerTrimestre, actualizarTrimestre} from '/src/modelos/trimestres.js';
        
        if(getUser().id !== getAdmin()){
            //redireccionar a la pagina de inicio
            window.location.href = 'index.html';
        }
        
        // Obtener el formulario
        const formulario = document.getElementById('formulario');

        // Obtener el boton guardar
        const botonGuardar = document.getElementById('guardar');
        
        // Obtener el tbody de la tabla
        const tbody = document.getElementById("trimestres");
        
        //Flag para saber si estamos editando o creando un trimestre
        let editStatus = false;

        // Variable para almacenar el id del trimestre a editar
        let id = '';
        
        // Obtener los trimestres del servidor usando el evento
        // DOMContentLoaded
        document.addEventListener('DOMContentLoaded', async () => {
            await obtenerTrimestres((datos) => {
                
                tbody.innerHTML = '';
                
                datos.forEach((trimestre) => {

                    tbody.innerHTML += `
                    <tr>
                        <td>1</td>
                        <td>${trimestre.nombre}</td>
                        <td>${trimestre.fecha_inicio} - ${trimestre.fecha_fin}</td>
                        <td>
                            <div class="tareas">
                                <button data-id="${trimestre.id}" class="editar">Editar</button>
                                <button data-id="${trimestre.id}" class="eliminar">Eliminar</button>
                            </div>
                        </td>
                    </tr>
                    `;
                });
                
                //Evento para editar los trimestres al dar clic en el boton .editar
                const btnsEditar = document.querySelectorAll('.editar');

                btnsEditar.forEach((btn) => {
                    btn.addEventListener('click', async () => {
                        
                        //Cambiar el estado de la bandera
                        editStatus = true;

                        //Obtener el id del trimestre
                        id = btn.dataset.id;                    
                        
                        try {
                            // Obtener los datos del trimestre
                            const trimestre = await obtenerTrimestre(id);
                            
                            // Asignar los datos al formulario
                            formulario.nombre.value = trimestre.nombre;
                            formulario.fecha_inicio.value = trimestre.fecha_inicio;
                            formulario.fecha_fin.value = trimestre.fecha_fin;
                            

                        } catch (error) {
                            console.log(error);
                        }
                    });
                });                
            });
        });
             

        // Agregar un evento al boton guardar
        botonGuardar.addEventListener('click', () => {
            // Obtener los datos del formulario
            const nombre = formulario.nombre.value;
            const fecha_inicio = formulario.fecha_inicio.value;
            const fecha_fin = formulario.fecha_fin.value;

            //validar que los campos no esten vacios
            if(nombre === '' || fecha_inicio === '' || fecha_fin === ''){
                alert('Todos los campos son obligatorios');
                return;
            }

            // Crear un objeto con los datos del formulario
            const datos = {
                nombre,
                fecha_inicio,
                fecha_fin
            };

            // Si estamos editando
            if(editStatus){
                // Actualizar los datos del trimestre  
                actualizarTrimestre(id, datos);
                
                //Cambiar la bandera a false
                editStatus = false;
                
                //Resetear el id
                id = '';
            }else{
                // Guardar los datos en el servidor
                guardarTrimestre(datos);
            }

            //Limpiar el formulario
            formulario.reset();
        });

    </script>
</body>
</html>